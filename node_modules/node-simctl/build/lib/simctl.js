'use strict';

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _asyncbox = require('asyncbox');

var _appiumLogger = require('appium-logger');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var log = (0, _appiumLogger.getLogger)('simctl');

function simExec(command, timeout) {
  var args = arguments.length <= 2 || arguments[2] === undefined ? [] : arguments[2];
  var env = arguments.length <= 3 || arguments[3] === undefined ? {} : arguments[3];
  return _regeneratorRuntime.async(function simExec$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        // run a particular simctl command
        args = ['simctl', command].concat(_toConsumableArray(args));
        log.info('Executing: xcrun with args: ' + args.join(' ') + ' and timeout: ' + timeout);
        // Prefix all passed in environment variables with 'SIMCTL_CHILD_', simctl
        // will then pass these to the child (spawned) process.
        env = _lodash2['default'].defaults(_lodash2['default'].mapKeys(env, function (value, key) {
          return 'SIMCTL_CHILD_' + key;
        }), process.env);

        context$1$0.prev = 3;
        return context$1$0.abrupt('return', (0, _teen_process.exec)('xcrun', args, { timeout: timeout, env: env }));

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](3);

        if (context$1$0.t0.stderr) {
          log.errorAndThrow('simctl error: ' + context$1$0.t0.stderr.trim());
        } else {
          log.errorAndThrow(context$1$0.t0);
        }

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 7]]);
}

function installApp(udid, appPath) {
  return _regeneratorRuntime.async(function installApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('install', 0, [udid, appPath]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function removeApp(udid, bundleId) {
  return _regeneratorRuntime.async(function removeApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('uninstall', 0, [udid, bundleId]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function launch(udid, bundleId) {
  return _regeneratorRuntime.async(function launch$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('launch', 0, [udid, bundleId]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function spawn(udid, executablePath) {
  var env = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];
  return _regeneratorRuntime.async(function spawn$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('spawn', 0, [udid, executablePath], env));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function shutdown(udid) {
  return _regeneratorRuntime.async(function shutdown$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('shutdown', 0, [udid]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function createDevice(name, deviceTypeId, runtimeId) {
  var out;
  return _regeneratorRuntime.async(function createDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        out = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(simExec('create', 0, [name, deviceTypeId, runtimeId]));

      case 4:
        out = context$1$0.sent;
        context$1$0.next = 10;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        log.errorAndThrow('Could not create simulator. Reason: ' + context$1$0.t0.stderr.trim());

      case 10:
        return context$1$0.abrupt('return', out.stdout.trim());

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function deleteDevice(udid) {
  return _regeneratorRuntime.async(function deleteDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('delete', 0, [udid]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function eraseDevice(udid) {
  var loopFn;
  return _regeneratorRuntime.async(function eraseDevice$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        loopFn = function loopFn() {
          return _regeneratorRuntime.async(function loopFn$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(simExec('erase', 2000, [udid]));

              case 2:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(5, 200, loopFn));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getDevices() {
  var forSdk = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];

  var _ref,
  // get the list of devices
  stdout, deviceSectionRe, matches, match, devices, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, sdk, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, line, lineRe, lineMatch;

  return _regeneratorRuntime.async(function getDevices$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('list', 0, ['devices']));

      case 2:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        deviceSectionRe = /-- iOS (.+) --(\n    .+)*/mg;
        matches = [];
        match = deviceSectionRe.exec(stdout);

        // make an entry for each sdk version
        while (match !== null) {
          matches.push(match);
          match = deviceSectionRe.exec(stdout);
        }
        if (matches.length < 1) {
          log.errorAndThrow('Could not find device section');
        }

        // get all the devices for each sdk
        devices = {};
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 13;
        _iterator = _getIterator(matches);

      case 15:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 51;
          break;
        }

        match = _step.value;
        sdk = match[1];

        devices[sdk] = [];
        // split the full match into lines and remove the first
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 22;
        _iterator2 = _getIterator(match[0].split('\n').slice(1));

      case 24:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 34;
          break;
        }

        line = _step2.value;
        lineRe = /^    ([^\(]+) \(([^\)]+)\) \(([^\)]+)\)/;
        lineMatch = lineRe.exec(line);

        if (!(lineMatch === null)) {
          context$1$0.next = 30;
          break;
        }

        throw new Error('Could not match line');

      case 30:
        // save the whole thing as ab object in the list for this sdk
        devices[sdk].push({
          name: lineMatch[1],
          udid: lineMatch[2],
          state: lineMatch[3]
        });

      case 31:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 24;
        break;

      case 34:
        context$1$0.next = 40;
        break;

      case 36:
        context$1$0.prev = 36;
        context$1$0.t0 = context$1$0['catch'](22);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 40:
        context$1$0.prev = 40;
        context$1$0.prev = 41;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 43:
        context$1$0.prev = 43;

        if (!_didIteratorError2) {
          context$1$0.next = 46;
          break;
        }

        throw _iteratorError2;

      case 46:
        return context$1$0.finish(43);

      case 47:
        return context$1$0.finish(40);

      case 48:
        _iteratorNormalCompletion = true;
        context$1$0.next = 15;
        break;

      case 51:
        context$1$0.next = 57;
        break;

      case 53:
        context$1$0.prev = 53;
        context$1$0.t1 = context$1$0['catch'](13);
        _didIteratorError = true;
        _iteratorError = context$1$0.t1;

      case 57:
        context$1$0.prev = 57;
        context$1$0.prev = 58;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 60:
        context$1$0.prev = 60;

        if (!_didIteratorError) {
          context$1$0.next = 63;
          break;
        }

        throw _iteratorError;

      case 63:
        return context$1$0.finish(60);

      case 64:
        return context$1$0.finish(57);

      case 65:
        if (!forSdk) {
          context$1$0.next = 69;
          break;
        }

        if (devices[forSdk]) {
          context$1$0.next = 68;
          break;
        }

        throw new Error('Sdk \'' + forSdk + '\' was not in list of simctl sdks');

      case 68:
        return context$1$0.abrupt('return', devices[forSdk]);

      case 69:
        return context$1$0.abrupt('return', devices);

      case 70:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[13, 53, 57, 65], [22, 36, 40, 48], [41,, 43, 47], [58,, 60, 64]]);
}

exports.installApp = installApp;
exports.removeApp = removeApp;
exports.launch = launch;
exports.spawn = spawn;
exports.shutdown = shutdown;
exports.createDevice = createDevice;
exports.deleteDevice = deleteDevice;
exports.eraseDevice = eraseDevice;
exports.getDevices = getDevices;

// retry erase with a sleep in between because it's flakey

// expect to get a listing like
// -- iOS 8.1 --
//     iPhone 4s (3CA6E7DD-220E-45E5-B716-1E992B3A429C) (Shutdown)
//     ...
// -- iOS 8.2 --
//     iPhone 4s (A99FFFC3-8E19-4DCF-B585-7D9D46B4C16E) (Shutdown)
//     ...
// so, get the `-- iOS X.X --` line to find the sdk (X.X)
// and the rest of the listing in order to later find the devices

// a line is something like
//    iPhone 4s (A99FFFC3-8E19-4DCF-B585-7D9D46B4C16E) (Shutdown)
// retrieve:
//   iPhone 4s
//   A99FFFC3-8E19-4DCF-B585-7D9D46B4C16E
//   Shutdown

// if a `forSdk` was passed in, return only the corresponding list

// otherwise return all the sdk -> device mappings.
//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQyxDQUFDOzs7Ozs7OztBQUE1QyxZQUFXO0FBT2QsY0FBYSxHQUFHLHlDQUF5QztBQUN6RCxpQkFBZ0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzs7Y0FDcEMsU0FBUyxLQUFLLElBQUksQ0FBQTs7Ozs7Y0FDZCxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQzs7OztBQUd6QyxlQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2hCLGNBQUksRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLGNBQUksRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLGVBQUssRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1NBQ3BCLENBQUMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2FBS0gsTUFBTTs7Ozs7WUFDSCxPQUFPLENBQUMsTUFBTSxDQUFDOzs7OztjQUNaLElBQUksS0FBSyxZQUFTLE1BQU0sdUNBQW1DOzs7NENBRTVELE9BQU8sQ0FBQyxNQUFNLENBQUM7Ozs0Q0FJakIsT0FBTzs7Ozs7OztDQUNmOztRQUVRLFVBQVUsR0FBVixVQUFVO1FBQUUsU0FBUyxHQUFULFNBQVM7UUFBRSxNQUFNLEdBQU4sTUFBTTtRQUFFLEtBQUssR0FBTCxLQUFLO1FBQUUsUUFBUSxHQUFSLFFBQVE7UUFBRSxZQUFZLEdBQVosWUFBWTtRQUM1RCxZQUFZLEdBQVosWUFBWTtRQUFFLFdBQVcsR0FBWCxXQUFXO1FBQUUsVUFBVSxHQUFWLFVBQVUiLCJmaWxlIjoibGliL3NpbWN0bC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGdldExvZ2dlciB9IGZyb20gJ2FwcGl1bS1sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBsb2cgPSBnZXRMb2dnZXIoJ3NpbWN0bCcpO1xuXG5hc3luYyBmdW5jdGlvbiBzaW1FeGVjIChjb21tYW5kOnN0cmluZywgdGltZW91dDpudW1iZXIsIGFyZ3M6QXJyYXkgPSBbXSxcbiAgICBlbnYgPSB7fSkge1xuICAvLyBydW4gYSBwYXJ0aWN1bGFyIHNpbWN0bCBjb21tYW5kXG4gIGFyZ3MgPSBbJ3NpbWN0bCcsIGNvbW1hbmQsIC4uLmFyZ3NdO1xuICBsb2cuaW5mbyhgRXhlY3V0aW5nOiB4Y3J1biB3aXRoIGFyZ3M6ICR7YXJncy5qb2luKCcgJyl9IGFuZCB0aW1lb3V0OiAke3RpbWVvdXR9YCk7XG4gIC8vIFByZWZpeCBhbGwgcGFzc2VkIGluIGVudmlyb25tZW50IHZhcmlhYmxlcyB3aXRoICdTSU1DVExfQ0hJTERfJywgc2ltY3RsXG4gIC8vIHdpbGwgdGhlbiBwYXNzIHRoZXNlIHRvIHRoZSBjaGlsZCAoc3Bhd25lZCkgcHJvY2Vzcy5cbiAgZW52ID0gXy5kZWZhdWx0cyhfLm1hcEtleXMoZW52LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7XG4gICAgcmV0dXJuICdTSU1DVExfQ0hJTERfJyArIGtleTtcbiAgfSksIHByb2Nlc3MuZW52KTtcblxuICB0cnkge1xuICAgIHJldHVybiBleGVjKCd4Y3J1bicsIGFyZ3MsIHt0aW1lb3V0LCBlbnZ9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLnN0ZGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYHNpbWN0bCBlcnJvcjogJHtlLnN0ZGVyci50cmltKCl9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsQXBwICh1ZGlkOnN0cmluZywgYXBwUGF0aDpzdHJpbmcpOnZvaWQge1xuICBhd2FpdCBzaW1FeGVjKCdpbnN0YWxsJywgMCwgW3VkaWQsIGFwcFBhdGhdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlQXBwICh1ZGlkOnN0cmluZywgYnVuZGxlSWQ6c3RyaW5nKTp2b2lkIHtcbiAgYXdhaXQgc2ltRXhlYygndW5pbnN0YWxsJywgMCwgW3VkaWQsIGJ1bmRsZUlkXSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxhdW5jaCAodWRpZDpzdHJpbmcsIGJ1bmRsZUlkOnN0cmluZyk6dm9pZCB7XG4gIGF3YWl0IHNpbUV4ZWMoJ2xhdW5jaCcsIDAsIFt1ZGlkLCBidW5kbGVJZF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzcGF3biAodWRpZDpzdHJpbmcsIGV4ZWN1dGFibGVQYXRoOnN0cmluZywgZW52ID0ge30pOnZvaWQge1xuICBhd2FpdCBzaW1FeGVjKCdzcGF3bicsIDAsIFt1ZGlkLCBleGVjdXRhYmxlUGF0aF0sIGVudik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNodXRkb3duICh1ZGlkOnN0cmluZyk6dm9pZCB7XG4gIGF3YWl0IHNpbUV4ZWMoJ3NodXRkb3duJywgMCwgW3VkaWRdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRGV2aWNlIChuYW1lOnN0cmluZywgZGV2aWNlVHlwZUlkOnN0cmluZyxcbiAgICBydW50aW1lSWQ6c3RyaW5nKTp2b2lkIHtcbiAgbGV0IG91dDtcbiAgdHJ5IHtcbiAgICBvdXQgPSBhd2FpdCBzaW1FeGVjKCdjcmVhdGUnLCAwLCBbbmFtZSwgZGV2aWNlVHlwZUlkLCBydW50aW1lSWRdKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgY3JlYXRlIHNpbXVsYXRvci4gUmVhc29uOiAke2Uuc3RkZXJyLnRyaW0oKX1gKTtcbiAgfVxuICByZXR1cm4gb3V0LnN0ZG91dC50cmltKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZURldmljZSAodWRpZDpzdHJpbmcpOnZvaWQge1xuICBhd2FpdCBzaW1FeGVjKCdkZWxldGUnLCAwLCBbdWRpZF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBlcmFzZURldmljZSAodWRpZDpzdHJpbmcpOnZvaWQge1xuICBsZXQgbG9vcEZuOkZ1bmN0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHNpbUV4ZWMoJ2VyYXNlJywgMjAwMCwgW3VkaWRdKTtcbiAgfTtcbiAgLy8gcmV0cnkgZXJhc2Ugd2l0aCBhIHNsZWVwIGluIGJldHdlZW4gYmVjYXVzZSBpdCdzIGZsYWtleVxuICBhd2FpdCByZXRyeUludGVydmFsKDUsIDIwMCwgbG9vcEZuKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlcyAoZm9yU2RrOnN0cmluZyA9IG51bGwpOk9iamVjdCB7XG4gIC8vIGdldCB0aGUgbGlzdCBvZiBkZXZpY2VzXG4gIGxldCB7IHN0ZG91dCB9ID0gYXdhaXQgc2ltRXhlYygnbGlzdCcsIDAsIFsnZGV2aWNlcyddKTtcblxuICAvLyBleHBlY3QgdG8gZ2V0IGEgbGlzdGluZyBsaWtlXG4gIC8vIC0tIGlPUyA4LjEgLS1cbiAgLy8gICAgIGlQaG9uZSA0cyAoM0NBNkU3REQtMjIwRS00NUU1LUI3MTYtMUU5OTJCM0E0MjlDKSAoU2h1dGRvd24pXG4gIC8vICAgICAuLi5cbiAgLy8gLS0gaU9TIDguMiAtLVxuICAvLyAgICAgaVBob25lIDRzIChBOTlGRkZDMy04RTE5LTREQ0YtQjU4NS03RDlENDZCNEMxNkUpIChTaHV0ZG93bilcbiAgLy8gICAgIC4uLlxuICAvLyBzbywgZ2V0IHRoZSBgLS0gaU9TIFguWCAtLWAgbGluZSB0byBmaW5kIHRoZSBzZGsgKFguWClcbiAgLy8gYW5kIHRoZSByZXN0IG9mIHRoZSBsaXN0aW5nIGluIG9yZGVyIHRvIGxhdGVyIGZpbmQgdGhlIGRldmljZXNcbiAgbGV0IGRldmljZVNlY3Rpb25SZTpSZWdFeHAgPSAvLS0gaU9TICguKykgLS0oXFxuICAgIC4rKSovbWc7XG4gIGxldCBtYXRjaGVzOkFycmF5ID0gW107XG4gIGxldCBtYXRjaDpPYmplY3QgPSBkZXZpY2VTZWN0aW9uUmUuZXhlYyhzdGRvdXQpO1xuXG4gIC8vIG1ha2UgYW4gZW50cnkgZm9yIGVhY2ggc2RrIHZlcnNpb25cbiAgd2hpbGUgKG1hdGNoICE9PSBudWxsKSB7XG4gICAgbWF0Y2hlcy5wdXNoKG1hdGNoKTtcbiAgICBtYXRjaCA9IGRldmljZVNlY3Rpb25SZS5leGVjKHN0ZG91dCk7XG4gIH1cbiAgaWYgKG1hdGNoZXMubGVuZ3RoIDwgMSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgZmluZCBkZXZpY2Ugc2VjdGlvbicpO1xuICB9XG5cbiAgLy8gZ2V0IGFsbCB0aGUgZGV2aWNlcyBmb3IgZWFjaCBzZGtcbiAgbGV0IGRldmljZXM6T2JqZWN0ID0ge307XG4gIGZvciAobWF0Y2ggb2YgbWF0Y2hlcykge1xuICAgIGxldCBzZGs6c3RyaW5nID0gbWF0Y2hbMV07XG4gICAgZGV2aWNlc1tzZGtdID0gW107XG4gICAgLy8gc3BsaXQgdGhlIGZ1bGwgbWF0Y2ggaW50byBsaW5lcyBhbmQgcmVtb3ZlIHRoZSBmaXJzdFxuICAgIGZvciAobGV0IGxpbmU6c3RyaW5nIG9mIG1hdGNoWzBdLnNwbGl0KCdcXG4nKS5zbGljZSgxKSkge1xuICAgICAgLy8gYSBsaW5lIGlzIHNvbWV0aGluZyBsaWtlXG4gICAgICAvLyAgICBpUGhvbmUgNHMgKEE5OUZGRkMzLThFMTktNERDRi1CNTg1LTdEOUQ0NkI0QzE2RSkgKFNodXRkb3duKVxuICAgICAgLy8gcmV0cmlldmU6XG4gICAgICAvLyAgIGlQaG9uZSA0c1xuICAgICAgLy8gICBBOTlGRkZDMy04RTE5LTREQ0YtQjU4NS03RDlENDZCNEMxNkVcbiAgICAgIC8vICAgU2h1dGRvd25cbiAgICAgIGxldCBsaW5lUmU6UmVnRXhwID0gL14gICAgKFteXFwoXSspIFxcKChbXlxcKV0rKVxcKSBcXCgoW15cXCldKylcXCkvO1xuICAgICAgbGV0IGxpbmVNYXRjaDpPYmplY3QgPSBsaW5lUmUuZXhlYyhsaW5lKTtcbiAgICAgIGlmIChsaW5lTWF0Y2ggPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgbWF0Y2ggbGluZScpO1xuICAgICAgfVxuICAgICAgLy8gc2F2ZSB0aGUgd2hvbGUgdGhpbmcgYXMgYWIgb2JqZWN0IGluIHRoZSBsaXN0IGZvciB0aGlzIHNka1xuICAgICAgZGV2aWNlc1tzZGtdLnB1c2goe1xuICAgICAgICBuYW1lOiBsaW5lTWF0Y2hbMV0sXG4gICAgICAgIHVkaWQ6IGxpbmVNYXRjaFsyXSxcbiAgICAgICAgc3RhdGU6IGxpbmVNYXRjaFszXSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vIGlmIGEgYGZvclNka2Agd2FzIHBhc3NlZCBpbiwgcmV0dXJuIG9ubHkgdGhlIGNvcnJlc3BvbmRpbmcgbGlzdFxuICBpZiAoZm9yU2RrKSB7XG4gICAgaWYgKCFkZXZpY2VzW2ZvclNka10pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgU2RrICcke2ZvclNka30nIHdhcyBub3QgaW4gbGlzdCBvZiBzaW1jdGwgc2Rrc2ApO1xuICAgIH1cbiAgICByZXR1cm4gZGV2aWNlc1tmb3JTZGtdO1xuICB9XG5cbiAgLy8gb3RoZXJ3aXNlIHJldHVybiBhbGwgdGhlIHNkayAtPiBkZXZpY2UgbWFwcGluZ3MuXG4gIHJldHVybiBkZXZpY2VzO1xufVxuXG5leHBvcnQgeyBpbnN0YWxsQXBwLCByZW1vdmVBcHAsIGxhdW5jaCwgc3Bhd24sIHNodXRkb3duLCBjcmVhdGVEZXZpY2UsXG4gICAgICAgICBkZWxldGVEZXZpY2UsIGVyYXNlRGV2aWNlLCBnZXREZXZpY2VzIH07XG4iXX0=
